name: Install Jenkins with Helm

on:
  workflow_dispatch:   # run manually
  push:
    branches:
      - main

jobs:
  install-jenkins:
    runs-on: self-hosted   # Windows node with Git Bash
    defaults:
      run:
         shell: "C:\\Program Files\\Git\\bin\\bash.exe {0}"   # âœ… force all steps to run in Bash

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create namespace for Jenkins
        run: |
          kubectl create namespace jenkins || echo "Namespace already exists"

      - name: Install Jenkins via Helm
        run: |
          helm upgrade --install jenkins jenkinsci/jenkins \
            --namespace jenkins \
            --set controller.serviceType=NodePort \
            --set controller.nodePort=30090 \
            --set persistence.enabled=true \
            --set persistence.size=200Mi \
            --set controller.resources.requests.cpu=200m \
            --set controller.resources.requests.memory=300Mi \
            --set controller.resources.limits.cpu=300m \
            --set controller.resources.limits.memory=400mi

      - name: Wait for Jenkins Pod to be Ready
        run: |
          kubectl rollout status deployment/jenkins --namespace=jenkins --timeout=300s

      - name: Get Jenkins Admin Password
        run: |
          echo "Admin password:"
          kubectl get secret --namespace jenkins jenkins \
            -o jsonpath="{.data.jenkins-admin-password}" | base64 --decode
          echo

      - name: Print Jenkins URL
        run: |
          echo "Jenkins URL: http://$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[0].address}'):30090"
