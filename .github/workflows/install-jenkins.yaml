name: Install Jenkins with Helm

on:
  workflow_dispatch:   # run manually
  push:
    branches:
      - main

jobs:
  install-jenkins:
    runs-on: self-hosted   # Windows node
    defaults:
      run:
        shell: pwsh  # Force PowerShell for all steps

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Add Jenkins Helm repo
        run: |
          helm repo add jenkinsci https://charts.jenkins.io
          helm repo update

      - name: Create namespace for Jenkins
        run: |
          try {
              kubectl create namespace jenkins
          } catch {
              Write-Host "Namespace already exists"
          }

      - name: Install Jenkins via Helm
        run: |
          helm upgrade --install jenkins jenkinsci/jenkins `
            --namespace jenkins `
            --set controller.serviceType=NodePort `
            --set controller.nodePort=30090 `
            --set persistence.enabled=true `
            --set persistence.size=200Mi `
            --set controller.resources.requests.cpu=200m `
            --set controller.resources.requests.memory=300Mi `
            --set controller.resources.limits.cpu=300m `
            --set controller.resources.limits.memory=400Mi

      - name: Wait for Jenkins Pod to be Ready
        run: |
          kubectl rollout status deployment/jenkins --namespace=jenkins --timeout=300s

      - name: Get Jenkins Admin Password
        run: |
          Write-Host "Admin password:"
          $password = kubectl get secret --namespace jenkins jenkins `
            -o jsonpath="{.data.jenkins-admin-password}" | base64 --decode
          Write-Host $password

      - name: Print Jenkins URL
        run: |
          $nodeIP = kubectl get nodes -o jsonpath='{.items[0].status.addresses[0].address}'
          Write-Host "Jenkins URL: http://$nodeIP:30090"
